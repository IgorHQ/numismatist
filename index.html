<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Нумізмат Mobile Pro</title>
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --gold: #f1c40f;
            --blue: #3498db;
            /* Висота зони для монети */
            --coin-height: 60vh; 
        }

        body { 
            margin: 0; overflow: hidden; background: #000; 
            font-family: -apple-system, system-ui, sans-serif; 
            color: white; -webkit-user-select: none; touch-action: manipulation;
        }

        /* Контейнер для 3D */
        #container3d {
            position: absolute; top: 0; left: 0; width: 100%;
            height: var(--coin-height); z-index: 1;
        }

        #menu { 
            position: fixed; inset: 0; background: #000; z-index: 3000; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }
        .menu-btn { 
            width: 100%; max-width: 300px; padding: 20px; margin: 10px; 
            border-radius: 20px; border: 2px solid var(--gold); 
            background: #111; color: white; font-size: 18px; font-weight: bold;
        }

        #ui-layer { display: none; position: relative; height: 100vh; z-index: 10; pointer-events: none; }
        #ui-layer button { pointer-events: auto; }
        
        #top-bar { 
            position: absolute; top: calc(10px + var(--safe-top)); 
            left: 15px; right: 15px; display: flex; justify-content: space-between; align-items: center;
        }
        .stat-group { display: flex; gap: 8px; }
        .stat { background: rgba(20,20,20,0.85); padding: 8px 12px; border-radius: 15px; border: 1px solid var(--gold); font-size: 13px; font-weight: bold; }

        .top-btns { display: flex; gap: 5px; }
        .reset-btn { background: rgba(231, 76, 60, 0.2); border: 1px solid #e74c3c; color: #e74c3c; padding: 8px 12px; border-radius: 12px; font-size: 11px; font-weight: bold; }
        .exit-btn { background: rgba(255, 255, 255, 0.1); border: 1px solid #fff; color: #fff; padding: 8px 12px; border-radius: 12px; font-size: 11px; font-weight: bold; }

        /* Вікно з результатом — тепер чітко під монетою */
        #modal {
            display: none; position: absolute; 
            top: calc(var(--coin-height) - 20px); /* Початок відразу під монетою */
            left: 50%; transform: translateX(-50%);
            background: rgba(20,20,20,0.95); padding: 15px; border-radius: 20px; 
            text-align: center; border: 1px solid var(--gold); 
            width: 85%; max-width: 300px; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        #album-window {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #111; padding: 20px; border-radius: 25px; z-index: 1500;
            border: 2px solid #9b59b6; width: 85%; height: 60vh; flex-direction: column; pointer-events: auto;
        }
        #album-list { flex: 1; overflow-y: auto; }
        .coin-row { background: #1a1a1a; margin-bottom: 8px; padding: 12px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; }

        .main-nav { 
            position: absolute; bottom: calc(20px + var(--safe-bottom)); 
            left: 0; right: 0; display: flex; justify-content: center; gap: 8px; padding: 0 15px;
        }
        .nav-btn { flex: 1; max-width: 130px; padding: 16px 5px; border-radius: 15px; border: none; font-weight: bold; font-size: 14px; }
        .btn-blue { background: #3498db; color: white; }
        .btn-gold { background: var(--gold); color: black; }
        .btn-purple { background: #9b59b6; color: white; }

        button:active { transform: scale(0.95); opacity: 0.8; }
        button:disabled { opacity: 0.3; }
    </style>
</head>
<body>

<div id="menu">
    <h1 style="color:var(--gold); margin-bottom: 30px;">НУМІЗМАТ</h1>
    <button class="menu-btn" onclick="startGame('easy')">Простий</button>
    <button class="menu-btn" onclick="startGame('medium')">Середній</button>
    <button class="menu-btn" onclick="startGame('realism')">Реалізм</button>
</div>

<div id="container3d"></div>

<div id="ui-layer">
    <div id="top-bar">
        <div class="stat-group">
            <div class="stat">₴ <span id="money-val" style="color:var(--gold)">0</span></div>
            <div class="stat">XP <span id="xp-val" style="color:var(--blue)">0</span></div>
        </div>
        <div class="top-btns">
            <button class="exit-btn" onclick="location.reload()">Меню</button>
            <button class="reset-btn" onclick="resetThisMode()">Reset</button>
        </div>
    </div>

    <div id="modal">
        <h3 id="m-title" style="margin: 0 0 5px 0; font-size: 18px; color:var(--gold)"></h3>
        <div id="coin-desc" style="margin-bottom: 12px; font-size:14px; line-height: 1.3;"></div>
        <div style="display:flex; gap:8px;">
            <button class="nav-btn btn-blue" style="width:50%; padding: 10px 0; height: auto;" onclick="keepFound()">В Альбом</button>
            <button class="nav-btn" style="width:50%; background:#333; color:white; padding: 10px 0; height: auto;" onclick="sellFound()">Продати</button>
        </div>
    </div>

    <div id="album-window">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0">Альбом</h3>
            <button onclick="toggleAlbum()" style="background:none; border:none; color:#ff4757; font-size:30px; padding:0 10px;">&times;</button>
        </div>
        <div id="album-list"></div>
    </div>

    <div class="main-nav">
        <button id="work-btn" class="nav-btn btn-blue" onclick="work()">Робота</button>
        <button id="search-btn" class="nav-btn btn-gold" onclick="search()">Шукати</button>
        <button class="nav-btn btn-purple" onclick="toggleAlbum()">Альбом</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
    let money = 0, xp = 0, myCoins = [], currentCoin = null;
    let config = {}, currentModeId = '';

    const modes = {
        easy: { search: 10, work: 100, rareChance: 0.3, garbageMin: 10, startMoney: 200 },
        medium: { search: 40, work: 60, rareChance: 0.15, garbageMin: 5, startMoney: 200 },
        realism: { search: 80, work: 40, rareChance: 0.05, garbageMin: 1, startMoney: 1000 }
    };

    function resetThisMode() {
        if (!currentModeId) return;
        if(confirm(`Скинути прогрес режиму "${currentModeId}"?`)) { 
            localStorage.removeItem('numizmat_' + currentModeId); 
            location.reload();
        }
    }

    function saveProgress() {
        if (!currentModeId) return;
        const data = { m: money, x: xp, a: myCoins };
        localStorage.setItem('numizmat_' + currentModeId, JSON.stringify(data));
    }

    function startGame(mode) {
        currentModeId = mode; 
        config = modes[mode];
        const saved = localStorage.getItem('numizmat_' + mode);
        if (saved) {
            const data = JSON.parse(saved);
            money = data.m; xp = data.x; myCoins = data.a || [];
        } else {
            money = config.startMoney; xp = 0; myCoins = [];
        }
        document.getElementById('menu').style.display = 'none';
        document.getElementById('ui-layer').style.display = 'block';
        updateUI();
    }

    // --- 3D ENGINE ---
    const container = document.getElementById('container3d');
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    container.appendChild(renderer.domElement);
    
    const light = new THREE.DirectionalLight(0xffffff, 2.5); light.position.set(2, 2, 5); scene.add(light);
    scene.add(new THREE.AmbientLight(0xffffff, 0.4));

    function createFace(text, label, isGold, isAvers, isIncuse) {
        const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 512;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = isGold ? '#ffd700' : '#dcdcdc';
        ctx.beginPath(); ctx.arc(256, 256, 250, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = '#856a00'; ctx.lineWidth = 15; ctx.stroke();
        ctx.save(); ctx.translate(256, 256);
        if (isAvers) ctx.scale(-1, -1);
        ctx.fillStyle = 'rgba(0,0,0,0.8)'; ctx.textAlign = 'center';
        if (isIncuse) {
            ctx.scale(-1, 1); ctx.font = 'bold 120px Arial'; ctx.fillText("UA", 0, 40);
        } else {
            ctx.font = 'bold 160px Arial'; ctx.fillText(text, 0, 30);
            ctx.font = 'bold 60px Arial'; ctx.fillText(label, 0, 110);
        }
        ctx.restore();
        const tex = new THREE.CanvasTexture(canvas); tex.center.set(0.5, 0.5);
        return tex;
    }

    const coinMesh = new THREE.Mesh(
        new THREE.CylinderGeometry(2, 2, 0.15, 64),
        [new THREE.MeshStandardMaterial({color: 0x856a00}), new THREE.MeshStandardMaterial(), new THREE.MeshStandardMaterial()]
    );
    coinMesh.rotation.z = Math.PI / 2;
    const pivot = new THREE.Group(); pivot.add(coinMesh); scene.add(pivot);
    camera.position.set(0, 0, 10); 

    function update3D(n, y, isInc, rot) {
        const isG = n >= 10;
        const rev = createFace(n, "коп.", isG, false, isInc);
        if (rot) rev.rotation = (rot * Math.PI) / 180;
        coinMesh.material[1].map = rev; coinMesh.material[1].needsUpdate = true;
        coinMesh.material[2].map = createFace("UA", y.toString(), isG, true, false);
        coinMesh.material[2].needsUpdate = true;
        
        // Авто-масштабування під розмір контейнера
        let s = (container.clientWidth < 500 ? 0.8 : 1.1);
        pivot.scale.set(s, s, s);
    }

    function search() {
        if (money < config.search) return;
        money -= config.search;
        const n = [1, 2, 5, 10, 25, 50][Math.floor(Math.random()*6)];
        const y = 1992 + Math.floor(Math.random()*30);
        const roll = Math.random();
        let price, err = "Звичайна", isR = false, rot = 0, isI = false;

        if (roll < config.rareChance) {
            isR = true;
            if (roll < 0.02) { err = "Інкуз (Раритет)"; price = 3000; isI = true; }
            else { rot = [90, 180, 270][Math.floor(Math.random()*3)]; err = `Поворот ${rot}°`; price = 200; }
        } else { price = config.garbageMin + Math.floor(Math.random()*5); }

        currentCoin = { n, y, e: err, price, rare: isR, rot, inc: isI };
        update3D(n, y, isI, rot);
        document.getElementById('m-title').innerText = isR ? "БРАК!" : "Монета";
        document.getElementById('coin-desc').innerHTML = `<b>${n} коп. ${y}</b><br>${err}<br>Ціна: ${price} ₴`;
        document.getElementById('modal').style.display = 'block';
        updateUI(); saveProgress();
    }

    function work() { if(xp >= 8) { xp -= 8; money += config.work; updateUI(); saveProgress(); } }
    function keepFound() { myCoins.push(currentCoin); xp += (currentCoin.rare?50:5); closeModal(); saveProgress(); }
    function sellFound() { money += currentCoin.price; closeModal(); saveProgress(); }
    function closeModal() { document.getElementById('modal').style.display = 'none'; updateUI(); }
    
    function toggleAlbum() {
        const w = document.getElementById('album-window');
        w.style.display = (w.style.display==='flex')?'none':'flex';
        if(w.style.display==='flex') renderAlbum();
    }
    
    function renderAlbum() {
        const list = document.getElementById('album-list'); list.innerHTML = '';
        myCoins.forEach((c, i) => {
            const row = document.createElement('div');
            row.className = 'coin-row';
            row.style.borderLeft = c.rare ? '4px solid #e74c3c' : '4px solid #444';
            row.onclick = () => { update3D(c.n, c.y, c.inc, c.rot); toggleAlbum(); };
            row.innerHTML = `<div><b>${c.n}к ${c.y}</b><br><small>${c.e}</small></div><button style="background:#e74c3c; color:white; border:none; padding:8px; border-radius:10px;" onclick="event.stopPropagation(); sellFromAlbum(${i})">${c.price}₴</button>`;
            list.appendChild(row);
        });
    }

    function sellFromAlbum(i) { money += myCoins[i].price; myCoins.splice(i, 1); updateUI(); renderAlbum(); saveProgress(); }
    
    function updateUI() {
        document.getElementById('money-val').innerText = money;
        document.getElementById('xp-val').innerText = xp;
        document.getElementById('work-btn').disabled = xp < 8;
        document.getElementById('search-btn').disabled = money < config.search;
    }

    function animate() { 
        requestAnimationFrame(animate); 
        pivot.rotation.y += 0.02; 
        renderer.render(scene, camera); 
    }
    animate();

    window.addEventListener('resize', () => {
        const w = container.clientWidth;
        const h = container.clientHeight;
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
        renderer.setSize(w, h);
    });
</script>
</body>
</html>
